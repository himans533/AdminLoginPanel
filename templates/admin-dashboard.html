<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Super Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #0052cc;
            --primary-light: #deebff;
            --secondary: #172b4d;
            --bg: #ffffff;
            --bg-secondary: #f4f5f7;
            --bg-tertiary: #ebecf0;
            --text: #172b4d;
            --text-secondary: #5e6c84;
            --text-muted: #97a0af;
            --border: #dfe1e6;
            --shadow: rgba(9, 30, 66, 0.08);
            --shadow-hover: rgba(9, 30, 66, 0.13);
            --success: #36b37e;
            --success-light: #e3fcef;
            --warning: #ff991f;
            --warning-light: #fff7e6;
            --danger: #de350b;
            --danger-light: #ffebe6;
            --info: #0065ff;
            --info-light: #deebff;
            --purple: #6554c0;
            --purple-light: #eae6ff;
            --theme-toggle-bg: #dfe1e6;
            --theme-toggle-icon: #172b4d;
            --bg-card: #ffffff;
            --bg-header: #ffffff;
        }

        [data-theme="dark"] {
            --bg-secondary: #0f111a;
            --bg: #1c1f2e;
            --bg-card: #1c1f2e;
            --bg-header: #1c1f2e;
            --text: #e0e6ed;
            --text-secondary: #94a3b8;
            --border: #2d3748;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(0, 0, 0, 0.6);
            --bg-tertiary: #2d3748;
            --theme-toggle-bg: #4a5568;
            --theme-toggle-icon: #fbbf24;

            /* Adjust chart/badge colors for dark mode if needed */
            --primary-light: rgba(0, 82, 204, 0.3);
            --success-light: rgba(54, 179, 126, 0.2);
            --danger-light: rgba(222, 53, 11, 0.2);
            --warning-light: rgba(255, 153, 31, 0.2);
            --info-light: rgba(0, 101, 255, 0.2);
            --purple-light: rgba(101, 84, 192, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family:
                -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                "Noto Sans", Ubuntu, "Helvetica Neue", sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            color: var(--text);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: var(--secondary);
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .sidebar-header .logo-container {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .company-logo {
            max-width: 180px;
            max-height: 50px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .sidebar-header h2 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 0.3px;
        }

        .sidebar-nav {
            padding: 12px 0;
        }

        .nav-section {
            padding: 8px 16px;
            margin-top: 8px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 3px;
            margin: 2px 8px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 0;
        }

        .top-header {
            background: var(--bg-header);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .breadcrumb-nav span {
            color: var(--text-secondary);
        }

        .breadcrumb-nav .current {
            color: var(--text);
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 3px;
            font-weight: 500;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle {
            background: var(--theme-toggle-bg);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--theme-toggle-icon);
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0747a6;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #2d9f6f;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--bg-secondary);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-area {
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-hover);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.projects {
            background: var(--info-light);
            color: var(--info);
        }

        .stat-icon.tasks {
            background: var(--purple-light);
            color: var(--purple);
        }

        .stat-icon.pending {
            background: var(--warning-light);
            color: var(--warning);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: #fff;
            margin: 8% auto;
            padding: 20px;
            border-radius: 8px;
        }

        .close {
            cursor: pointer;
            font-size: 22px;
        }

        .stat-icon.overdue {
            background: var(--danger-light);
            color: var(--danger);
        }

        .stat-icon.completed {
            background: var(--success-light);
            color: var(--success);
        }

        .stat-icon.users {
            background: var(--primary-light);
            color: var(--primary);
        }

        .stat-info h3 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .stat-info p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 4px 0 0;
        }

        .tabs-container {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 1px 3px var(--shadow);
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid var(--bg-tertiary);
            padding: 0 16px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 16px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .tab-btn:hover {
            color: var(--text);
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn.active::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-btn .badge {
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .project-card:hover {
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateY(-2px);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .project-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 4px;
        }

        .project-coordinator {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .project-priority {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: var(--danger-light);
            color: var(--danger);
        }

        .priority-medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .priority-low {
            background: var(--success-light);
            color: var(--success);
        }

        .project-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-progress {
            margin-bottom: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .progress-label {
            color: var(--text-secondary);
        }

        .progress-value {
            font-weight: 600;
            color: var(--text);
        }

        .progress-bar-container {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-bar-fill.low {
            background: var(--danger);
        }

        .progress-bar-fill.medium {
            background: var(--warning);
        }

        .progress-bar-fill.high {
            background: var(--success);
        }

        .project-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .meta-item i {
            font-size: 14px;
        }

        .meta-item.overdue {
            color: var(--danger);
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
        }

        .task-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .task-table td {
            padding: 12px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .task-table tr:hover {
            background: var(--bg-secondary);
        }

        .task-table tr.overdue-row {
            background: var(--danger-light);
        }

        .task-title-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-type-icon {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }

        .task-type-icon.task {
            background: var(--info);
        }

        .task-type-icon.bug {
            background: var(--danger);
        }

        .task-type-icon.story {
            background: var(--success);
        }

        .task-id {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.todo {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .status-badge.in-progress {
            background: var(--info-light);
            color: var(--info);
        }

        .status-badge.review {
            background: var(--purple-light);
            color: var(--purple);
        }

        .status-badge.completed {
            background: var(--success-light);
            color: var(--success);
        }

        .status-badge.blocked {
            background: var(--danger-light);
            color: var(--danger);
        }

        .status-badge.overdue {
            background: var(--danger-light);
            color: var(--danger);
        }

        .status-badge.pending {
            background: var(--warning-light);
            color: var(--warning);
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        .avatar-group {
            display: flex;
        }

        .avatar-group .avatar {
            margin-left: -8px;
            border: 2px solid white;
        }

        .avatar-group .avatar:first-child {
            margin-left: 0;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(9, 30, 66, 0.54);
            z-index: 2000;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 8px 16px rgba(9, 30, 66, 0.25);
            animation: modalSlideIn 0.2s ease;
        }

        .modal-content.wide {
            max-width: 900px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 3px;
            font-size: 14px;
            transition: border-color 0.2s;
            background: var(--bg);
            color: var(--text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        select.form-control {
            cursor: pointer;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .permissions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .permission-item label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }

        .permission-item input[type="checkbox"] {
            cursor: pointer;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 3px;
            font-size: 14px;
        }

        .alert-danger {
            background: var(--danger-light);
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }

        .activity-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 320px;
            height: 100vh;
            width: 320px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 900;
            display: flex;
            flex-direction: column;
        }

        .activity-panel.open {
            transform: translateX(0);
        }

        .activity-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .activity-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .activity-icon.task {
            background: var(--info-light);
            color: var(--info);
        }

        .activity-icon.milestone {
            background: var(--purple-light);
            color: var(--purple);
        }

        .activity-icon.report {
            background: var(--success-light);
            color: var(--success);
        }

        .activity-icon.project {
            background: var(--warning-light);
            color: var(--warning);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 13px;
            color: var(--text);
            margin: 0 0 4px;
            line-height: 1.4;
        }

        .activity-text strong {
            color: var(--primary);
        }

        .activity-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .hierarchy-tree {
            padding: 20px;
        }

        .tree-node {
            position: relative;
            padding-left: 24px;
        }

        .tree-node::before {
            content: "";
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .tree-node:last-child::before {
            height: 16px;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            margin: 4px 0;
            background: var(--bg-secondary);
            border-radius: 6px;
            position: relative;
        }

        .tree-item::before {
            content: "";
            position: absolute;
            left: -16px;
            width: 16px;
            height: 2px;
            background: var(--border);
        }

        .tree-item.super-admin {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: var(--secondary);
        }

        .tree-item.coordinator {
            background: var(--purple-light);
            color: var(--purple);
        }

        .tree-item.team-member {
            background: var(--info-light);
            color: var(--info);
        }

        .tree-item .icon {
            font-size: 16px;
        }

        .tree-item .name {
            font-weight: 600;
            font-size: 14px;
        }

        .tree-item .role {
            font-size: 11px;
            opacity: 0.8;
        }

        .history-timeline {
            position: relative;
            padding-left: 24px;
        }

        .history-timeline::before {
            content: "";
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .history-item {
            position: relative;
            padding: 12px 0;
        }

        .history-item::before {
            content: "";
            position: absolute;
            left: -20px;
            top: 16px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
        }

        .history-item.created::before {
            background: var(--success);
        }

        .history-item.assigned::before {
            background: var(--info);
        }

        .history-item.progress::before {
            background: var(--warning);
        }

        .history-item.completed::before {
            background: var(--purple);
        }

        .history-item .content {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 6px;
        }

        .history-item .content p {
            margin: 0;
            font-size: 14px;
            color: var(--text);
        }

        .history-item .content .time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h4 {
            margin-bottom: 8px;
            color: var(--text);
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: var(--secondary);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-top: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            animation: slideInRight 0.3s ease;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* New Styles */
        .avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            margin: 0 auto;
        }

        .permission-card {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
            margin-bottom: 10px;
        }

        .permission-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .permission-tag {
            background: var(--primary-light);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .user-type-admin {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: var(--secondary);
        }

        .user-type-coordinator {
            background: var(--purple-light);
            color: var(--purple);
        }

        .user-type-member {
            background: var(--info-light);
            color: var(--info);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .stat-card:nth-child(6) .stat-icon.users {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="header-top-row"
                    style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                    <div class="logo-container">
                        <img src="{{ url_for('static', filename='logo_processed.png') }}" alt="SLRD Logo"
                            class="company-logo">
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme"
                        style="background: transparent; border: 1px solid rgba(255,255,255,0.1); color: white; width: 32px; height: 32px; margin: 0;">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
                <h2>Super Admin Dashboard</h2>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" onclick="switchTab('projects')">
                        <i class="fas fa-folder"></i>
                        Active Projects
                        <span class="nav-badge" id="nav-projects-count">0</span>
                    </a>
                    <a class="nav-item" onclick="switchTab('active-tasks')">
                        <i class="fas fa-tasks"></i>
                        Active Tasks
                    </a>
                    <a class="nav-item" onclick="switchTab('pending-tasks')">
                        <i class="fas fa-clock"></i>
                        Pending Tasks
                    </a>
                    <a class="nav-item" onclick="switchTab('overdue-tasks')">
                        <i class="fas fa-exclamation-triangle"></i>
                        Overdue Tasks
                        <span class="nav-badge" id="nav-overdue-count">0</span>
                    </a>
                    <a class="nav-item" onclick="switchTab('completed-tasks')">
                        <i class="fas fa-check-circle"></i>
                        Completed Tasks
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a class="nav-item" onclick="openModal('createProjectModal')">
                        <i class="fas fa-plus-circle"></i>
                        Create Project
                    </a>
                    <a class="nav-item" onclick="openHierarchyModal()">
                        <i class="fas fa-sitemap"></i>
                        User Hierarchy
                    </a>
                    <a class="nav-item" onclick="toggleActivityPanel()">
                        <i class="fas fa-bell"></i>
                        Live Activity
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <a class="nav-item" href="/admin/daily-reports">
                        <i class="fas fa-file-alt"></i>
                        Daily Reports
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <div class="breadcrumb-nav">
                    <i class="fas fa-home"></i>
                    <span>/</span>
                    <span class="current">Dashboard</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openUserTypeModal()">
                        <i class="fas fa-plus"></i> Create UserType
                    </button>
                    <button class="btn btn-success" onclick="openCreateUserModal()">
                        <i class="fas fa-user-plus"></i> Create User
                    </button>
                    <button class="btn btn-primary" onclick="openModal('createProjectModal')">
                        <i class="fas fa-plus"></i>
                        Create Project
                    </button>
                    <button class="btn btn-outline" onclick="toggleActivityPanel()">
                        <i class="fas fa-bell"></i>
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </header>

            <div class="content-area">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card" onclick="switchTab('projects')">
                        <div class="stat-icon projects">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-projects">0</h3>
                            <p>Active Projects</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="switchTab('active-tasks')">
                        <div class="stat-icon tasks">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-active-tasks">0</h3>
                            <p>Active Tasks</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="switchTab('pending-tasks')">
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-pending">0</h3>
                            <p>Pending Tasks</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="switchTab('overdue-tasks')">
                        <div class="stat-icon overdue">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-overdue">0</h3>
                            <p>Overdue Tasks</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="switchTab('completed-tasks')">
                        <div class="stat-icon completed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-completed">0</h3>
                            <p>Completed Tasks</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="openUsersModal()" style="cursor:pointer;">
                        <div class="stat-icon users">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-users">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="openUsertypeListModal()" style="cursor:pointer;">
                        <div class="stat-icon" style="background: var(--purple-light); color: var(--purple);">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-usertypes">0</h3>
                            <p>Total User Types</p>
                        </div>
                    </div>
                </div>

                <!-- Tabs Container -->
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="projects">
                            <i class="fas fa-folder"></i> Active Projects
                            <span class="badge bg-primary" id="tab-projects-count">0</span>
                        </button>
                        <button class="tab-btn" data-tab="active-tasks">
                            <i class="fas fa-spinner"></i> Active Tasks
                            <span class="badge bg-info" id="tab-active-count">0</span>
                        </button>
                        <button class="tab-btn" data-tab="pending-tasks">
                            <i class="fas fa-clock"></i> Pending Tasks
                            <span class="badge bg-warning" id="tab-pending-count">0</span>
                        </button>
                        <button class="tab-btn" data-tab="overdue-tasks">
                            <i class="fas fa-exclamation-triangle"></i>
                            Overdue Tasks
                            <span class="badge bg-danger" id="tab-overdue-count">0</span>
                        </button>
                        <button class="tab-btn" data-tab="completed-tasks">
                            <i class="fas fa-check"></i> Completed Tasks
                            <span class="badge bg-success" id="tab-completed-count">0</span>
                        </button>
                    </div>

                    <!-- Active Projects Tab -->
                    <div class="tab-content active" id="tab-projects">
                        <div class="loading-spinner" id="projects-loading">
                            <div class="spinner"></div>
                        </div>
                        <div class="projects-grid" id="projects-grid"></div>
                    </div>

                    <!-- Active Tasks Tab -->
                    <div class="tab-content" id="tab-active-tasks">
                        <div class="loading-spinner" id="active-tasks-loading">
                            <div class="spinner"></div>
                        </div>
                        <table class="task-table" id="active-tasks-table" style="display: none">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Project</th>
                                    <th>Assigned To</th>
                                    <th>Deadline</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="active-tasks-body"></tbody>
                        </table>
                    </div>

                    <!-- Pending Tasks Tab -->
                    <div class="tab-content" id="tab-pending-tasks">
                        <div class="loading-spinner" id="pending-tasks-loading">
                            <div class="spinner"></div>
                        </div>
                        <table class="task-table" id="pending-tasks-table" style="display: none">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Project</th>
                                    <th>Assigned To</th>
                                    <th>Deadline</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-tasks-body"></tbody>
                        </table>
                    </div>

                    <!-- Overdue Tasks Tab -->
                    <div class="tab-content" id="tab-overdue-tasks">
                        <div class="loading-spinner" id="overdue-tasks-loading">
                            <div class="spinner"></div>
                        </div>
                        <table class="task-table" id="overdue-tasks-table" style="display: none">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Project</th>
                                    <th>Assigned To</th>
                                    <th>Deadline</th>
                                    <th>Days Overdue</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="overdue-tasks-body"></tbody>
                        </table>
                    </div>

                    <!-- Completed Tasks Tab -->
                    <div class="tab-content" id="tab-completed-tasks">
                        <div class="loading-spinner" id="completed-tasks-loading">
                            <div class="spinner"></div>
                        </div>
                        <table class="task-table" id="completed-tasks-table" style="display: none">
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Project</th>
                                    <th>Completed By</th>
                                    <th>Completed On</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="completed-tasks-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Activity Panel -->
        <aside class="activity-panel" id="activityPanel">
            <div class="activity-header">
                <h3><i class="fas fa-bell"></i> Live Activity</h3>
                <button class="modal-close" onclick="toggleActivityPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="activity-list" id="activity-list">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- UserType List Modal -->
    <div class="modal-overlay" id="usertypeListModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-list"></i> User Types</h3>
                <button class="modal-close" onclick="closeModal('usertypeListModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="task-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>User Role</th>
                                <th>Description</th>
                                <th>Permissions</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usertypesTableBody">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner" style="margin: 20px auto;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('usertypeListModal')">
                    Close
                </button>
                <button class="btn btn-primary"
                    onclick="closeModal('usertypeListModal'); openModal('createUserTypeModal'); document.getElementById('createUserTypeForm').reset();">
                    <i class="fas fa-plus"></i> Create New User Type
                </button>
            </div>
        </div>
    </div>

    <!-- Users Modal -->
    <div class="modal-overlay" id="usersModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-users"></i> All Users</h3>
                <button class="modal-close" onclick="closeModal('usersModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="usersModalContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('usersModal')">
                    Close
                </button>
                <button class="btn btn-primary" onclick="openCreateUserModal()">
                    <i class="fas fa-user-plus"></i> Create New User
                </button>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal-overlay" id="userDetailModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> User Details</h3>
                <button class="modal-close" onclick="closeModal('userDetailModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="userDetailContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userDetailModal')">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div class="modal-overlay" id="createProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-folder-plus"></i> Create New Project
                </h3>
                <button class="modal-close" onclick="closeModal('createProjectModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createProjectForm" onsubmit="createProject(event)">
                    <div class="form-group">
                        <label>Project Name *</label>
                        <input type="text" class="form-control" id="projectName" required=""
                            placeholder="Enter project name">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="projectDescription"
                            placeholder="Enter project description"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Deadline *</label>
                            <input type="date" class="form-control" id="projectDeadline" required="">
                        </div>
                        <div class="form-group">
                            <label>Reporting Time</label>
                            <input type="time" class="form-control" id="projectReportingTime" value="09:00">
                        </div>
                    </div>


                    <!-- Team Members Section -->
                    <div style="
                                margin-top: 18px;
                                padding-top: 16px;
                                border-top: 2px solid var(--border);
                            ">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 style="margin: 0; font-size: 14px">
                                Team Members
                                <span id="teamMemberCount" class="badge" style="
                                    background: var(--primary);
                                    color: white;
                                    font-size: 11px;
                                    padding: 2px 8px;
                                    border-radius: 12px;
                                    margin-left: 8px;
                                ">0</span>
                            </h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline" onclick="openAddTeamMemberModal()">
                                    <i class="fas fa-user-plus"></i> Add New
                                    Team Member
                                </button>
                            </div>
                        </div>

                        <div id="projectTeamContainer" style="
                                    display: grid;
                                    gap: 10px;
                                    max-height: 220px;
                                    overflow-y: auto;
                                    padding-right: 4px;
                                ">
                            <div class="team-member-row empty-state"><i class="fas fa-users"></i>
                                <div style="margin-top:8px;">No users found. Add new members.</div>
                            </div>
                        </div>

                        <small class="text-muted">Select existing users to add to this project,
                            or click
                            <strong>Add New Team Member</strong>.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createProjectModal')">
                    Cancel
                </button>
                <button type="submit" form="createProjectForm" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Project
                </button>

            </div>
        </div>
    </div>

    <!-- Create UserType Modal -->
    <div class="modal-overlay" id="createUserTypeModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-users-cog"></i> Create User Type</h3>
                <button class="modal-close" onclick="closeModal('createUserTypeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createUserTypeForm" onsubmit="event.preventDefault(); createUserTypeSubmit();">
                    <div id="usertypeError" style="margin-bottom: 15px;"></div>

                    <div class="form-group">
                        <label>User Role Name *</label>
                        <input type="text" class="form-control" id="typRole" required
                            placeholder="e.g., Project Manager, Team Lead, Analyst">
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="typDescription" rows="3"
                            placeholder="Describe the purpose of this user type"></textarea>
                    </div>

                    <!-- Permissions Section -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">Assign Permissions</h4>

                        <div id="permissionsContainer" style="display: grid; gap: 15px;">
                            <!-- Hierarchy Permissions -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                                <h5 style="margin: 0 0 12px 0; color: var(--primary); font-size: 14px;">Hierarchy &
                                    Organization</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="ADMIN_VIEW_HIERARCHY"
                                            class="perm-checkbox">
                                        <span>View User Hierarchy</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="ADMIN_CREATE_USERTYPE"
                                            class="perm-checkbox">
                                        <span>Create User Type</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="ADMIN_MANAGE_PERMISSIONS"
                                            class="perm-checkbox">
                                        <span>Manage Permissions</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Project Permissions -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--purple);">
                                <h5 style="margin: 0 0 12px 0; color: var(--purple); font-size: 14px;">Projects</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="PROJ_VIEW_ALL"
                                            class="perm-checkbox">
                                        <span>View All Projects</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="PROJ_CREATE"
                                            class="perm-checkbox">
                                        <span>Create Project</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="PROJ_EDIT"
                                            class="perm-checkbox">
                                        <span>Edit Project</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="PROJ_DELETE"
                                            class="perm-checkbox">
                                        <span>Delete Project</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="PROJ_ASSIGN_COORD"
                                            class="perm-checkbox">
                                        <span>Assign Coordinator</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Task Permissions -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                                <h5 style="margin: 0 0 12px 0; color: var(--info); font-size: 14px;">Tasks</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TASK_VIEW"
                                            class="perm-checkbox">
                                        <span>View Tasks</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TASK_CREATE"
                                            class="perm-checkbox">
                                        <span>Create Task</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TASK_ASSIGN"
                                            class="perm-checkbox">
                                        <span>Assign Task</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TASK_EDIT"
                                            class="perm-checkbox">
                                        <span>Edit Task</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Team Member Permissions -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                                <h5 style="margin: 0 0 12px 0; color: var(--success); font-size: 14px;">Team Management
                                </h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TEAM_VIEW"
                                            class="perm-checkbox">
                                        <span>View Team</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TEAM_ADD_MEMBER"
                                            class="perm-checkbox">
                                        <span>Add Team Member</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TEAM_REMOVE_MEMBER"
                                            class="perm-checkbox">
                                        <span>Remove Team Member</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="TEAM_MANAGE"
                                            class="perm-checkbox">
                                        <span>Manage Team</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Reports & Approvals -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                                <h5 style="margin: 0 0 12px 0; color: var(--warning); font-size: 14px;">Reports &
                                    Approvals</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="REP_VIEW" class="perm-checkbox">
                                        <span>View Reports</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="REP_APPROVE"
                                            class="perm-checkbox">
                                        <span>Approve Reports</span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" name="permission" value="REP_REJECT"
                                            class="perm-checkbox">
                                        <span>Reject Reports</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserTypeModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="createUserTypeSubmit()">
                    <i class="fas fa-check"></i> Create User Type
                </button>
            </div>
        </div>
    </div>

    <!-- Update UserType Modal -->
    <div class="modal-overlay" id="updateUserTypeModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Update User Type</h3>
                <button class="modal-close" onclick="closeModal('updateUserTypeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateUserTypeForm" onsubmit="event.preventDefault(); updateUserTypeSubmit();">
                    <input type="hidden" id="editTypId">
                    <div id="updateUsertypeError" style="margin-bottom: 15px;"></div>

                    <div class="form-group">
                        <label>User Role Name *</label>
                        <input type="text" class="form-control" id="editTypRole" required>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="editTypDescription" rows="3"></textarea>
                    </div>

                    <!-- Permissions Section (Copied from Create) -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">Assign Permissions</h4>
                        <div id="editPermissionsContainer" style="display: grid; gap: 15px;">
                            <!-- Hierarchy & Organization -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                                <h5 style="margin: 0 0 12px 0; color: var(--primary); font-size: 14px;">Hierarchy &
                                    Organization</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label class="perm-label"><input type="checkbox" value="ADMIN_VIEW_HIERARCHY"
                                            class="perm-checkbox"> <span>View User Hierarchy</span></label>
                                    <label class="perm-label"><input type="checkbox" value="ADMIN_CREATE_USERTYPE"
                                            class="perm-checkbox"> <span>Create User Type</span></label>
                                    <label class="perm-label"><input type="checkbox" value="ADMIN_MANAGE_PERMISSIONS"
                                            class="perm-checkbox"> <span>Manage Permissions</span></label>
                                </div>
                            </div>
                            <!-- Projects -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--purple);">
                                <h5 style="margin: 0 0 12px 0; color: var(--purple); font-size: 14px;">Projects</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label class="perm-label"><input type="checkbox" value="PROJ_VIEW_ALL"
                                            class="perm-checkbox"> <span>View All Projects</span></label>
                                    <label class="perm-label"><input type="checkbox" value="PROJ_CREATE"
                                            class="perm-checkbox"> <span>Create Project</span></label>
                                    <label class="perm-label"><input type="checkbox" value="PROJ_EDIT"
                                            class="perm-checkbox"> <span>Edit Project</span></label>
                                    <label class="perm-label"><input type="checkbox" value="PROJ_DELETE"
                                            class="perm-checkbox"> <span>Delete Project</span></label>
                                    <label class="perm-label"><input type="checkbox" value="PROJ_ASSIGN_COORD"
                                            class="perm-checkbox"> <span>Assign Coordinator</span></label>
                                </div>
                            </div>
                            <!-- Tasks -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info);">
                                <h5 style="margin: 0 0 12px 0; color: var(--info); font-size: 14px;">Tasks</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label class="perm-label"><input type="checkbox" value="TASK_VIEW"
                                            class="perm-checkbox"> <span>View Tasks</span></label>
                                    <label class="perm-label"><input type="checkbox" value="TASK_CREATE"
                                            class="perm-checkbox"> <span>Create Task</span></label>
                                    <label class="perm-label"><input type="checkbox" value="TASK_ASSIGN"
                                            class="perm-checkbox"> <span>Assign Task</span></label>
                                    <label class="perm-label"><input type="checkbox" value="TASK_EDIT"
                                            class="perm-checkbox"> <span>Edit Task</span></label>
                                </div>
                            </div>
                            <!-- Team Management -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                                <h5 style="margin: 0 0 12px 0; color: var(--success); font-size: 14px;">Team Management
                                </h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label class="perm-label"><input type="checkbox" value="TEAM_VIEW"
                                            class="perm-checkbox"> <span>View Team</span></label>
                                    <label class="perm-label"><input type="checkbox" value="TEAM_ADD_MEMBER"
                                            class="perm-checkbox"> <span>Add Team Member</span></label>
                                    <label class="perm-label"><input type="checkbox" value="TEAM_REMOVE_MEMBER"
                                            class="perm-checkbox"> <span>Remove Team Member</span></label>
                                    <label class="perm-label"><input type="checkbox" value="TEAM_MANAGE"
                                            class="perm-checkbox"> <span>Manage Team</span></label>
                                </div>
                            </div>
                            <!-- Reports & Approvals -->
                            <div
                                style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                                <h5 style="margin: 0 0 12px 0; color: var(--warning); font-size: 14px;">Reports &
                                    Approvals</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <label class="perm-label"><input type="checkbox" value="REP_VIEW"
                                            class="perm-checkbox"> <span>View Reports</span></label>
                                    <label class="perm-label"><input type="checkbox" value="REP_APPROVE"
                                            class="perm-checkbox"> <span>Approve Reports</span></label>
                                    <label class="perm-label"><input type="checkbox" value="REP_REJECT"
                                            class="perm-checkbox"> <span>Reject Reports</span></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('updateUserTypeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateUserTypeSubmit()">Update Change</button>
            </div>
        </div>
    </div>

    <!-- View UserType Modal -->
    <div class="modal-overlay" id="viewUserTypeModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> View User Type</h3>
                <button class="modal-close" onclick="closeModal('viewUserTypeModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h4 id="viewTypRole" style="font-size: 18px; color: var(--primary);"></h4>
                    <p id="viewTypDescription" class="text-muted"></p>
                </div>
                <div style="border-top: 1px solid var(--border); padding-top: 20px;">
                    <h5>Assigned Permissions</h5>
                    <div id="viewPermissionsList" class="permission-tags" style="margin-top: 15px;">

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewUserTypeModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3>Create New Employee</h3>
                <button class="modal-close" onclick="closeModal('createUserModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createUserForm" onsubmit="event.preventDefault(); createUserSubmit();">
                    <div id="userError" style="margin-bottom: 15px;"></div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" class="form-control" id="usrUsername" required
                                placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" class="form-control" id="usrEmail" required
                                placeholder="employee@example.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="password" class="form-control" id="usrPassword" required
                                placeholder="Min 8 characters, 2 special chars">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password *</label>
                            <input type="password" class="form-control" id="usrConfirmPassword" required
                                placeholder="Confirm password">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>User Type *</label>
                        <select class="form-control" id="usrUserType" required>
                            <option value="">Select a user type</option>
                        </select>
                    </div>

                    <!-- Module Permissions -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">Module Permissions</h4>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Projects -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-folder"></i> Projects
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjView" data-module="Proj" data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjAdd" data-module="Proj" data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjEdit" data-module="Proj" data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDelete" data-module="Proj"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>

                            <!-- Project Team -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-users"></i> Project Team
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjTeamView" data-module="Proj_team"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjTeamAdd" data-module="Proj_team"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjTeamEdit" data-module="Proj_team"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjTeamDelete" data-module="Proj_team"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>

                            <!-- Documents -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-file-alt"></i> Documents
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDocView" data-module="Proj_doc"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDocAdd" data-module="Proj_doc"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDocEdit" data-module="Proj_doc"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDocDelete" data-module="Proj_doc"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDocDownload" data-module="Proj_doc"
                                            data-action="Download">
                                        Download
                                    </label>
                                </div>
                            </div>

                            <!-- Discussion -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-comments"></i> Discussion
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDisView" data-module="Proj_Dis_"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDisAdd" data-module="Proj_Dis_"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDisEdit" data-module="Proj_Dis_"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permProjDisDelete" data-module="Proj_Dis_"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>

                            <!-- Tasks -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-tasks"></i> Tasks
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permTaskView" data-module="task" data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permTaskAdd" data-module="task" data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permTaskEdit" data-module="task" data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="permTaskDelete" data-module="task"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="createUserSubmit()">
                    Create Employee
                </button>
            </div>
        </div>
    </div>

    <!-- Update User Modal -->
    <div class="modal-overlay" id="updateUserModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3>Update Employee</h3>
                <button class="modal-close" onclick="closeModal('updateUserModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateUserForm" onsubmit="updateUser(event)">
                    <input type="hidden" id="updateUsrId">
                    <div id="updateUserError" style="margin-bottom: 15px;"></div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" class="form-control" id="updateUsrUsername" required
                                placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" class="form-control" id="updateUsrEmail" required
                                placeholder="employee@example.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="updateUsrPassword"
                            placeholder="Min 8 characters, 2 special chars">
                    </div>

                    <div class="form-group">
                        <label>User Type *</label>
                        <select class="form-control" id="updateUsrUserType" required>
                            <option value="">Select a user type</option>
                        </select>
                    </div>

                    <!-- Module Permissions -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 16px;">Module Permissions</h4>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Projects -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-folder"></i> Projects
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjView" data-module="Proj"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjAdd" data-module="Proj"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjEdit" data-module="Proj"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDelete" data-module="Proj"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>

                            <!-- Project Team -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-users"></i> Project Team
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjTeamView" data-module="Proj_team"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjTeamAdd" data-module="Proj_team"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjTeamEdit" data-module="Proj_team"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjTeamDelete" data-module="Proj_team"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>

                            <!-- Documents -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-file-alt"></i> Documents
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDocView" data-module="Proj_doc"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDocAdd" data-module="Proj_doc"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDocEdit" data-module="Proj_doc"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDocDelete" data-module="Proj_doc"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDocDownload" data-module="Proj_doc"
                                            data-action="Download">
                                        Download
                                    </label>
                                </div>
                            </div>

                            <!-- Discussion -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-comments"></i> Discussion
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDisView" data-module="Proj_Dis_"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDisAdd" data-module="Proj_Dis_"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDisEdit" data-module="Proj_Dis_"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermProjDisDelete" data-module="Proj_Dis_"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>

                            <!-- Tasks -->
                            <div>
                                <h5 style="font-weight: 600; color: var(--text); margin-bottom: 8px;">
                                    <i class="fas fa-tasks"></i> Tasks
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermTaskView" data-module="task"
                                            data-action="View">
                                        View
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermTaskAdd" data-module="task"
                                            data-action="Add">
                                        Add
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermTaskEdit" data-module="task"
                                            data-action="Edit">
                                        Edit
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                        <input type="checkbox" id="updatePermTaskDelete" data-module="task"
                                            data-action="Delete">
                                        Delete
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('updateUserModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="updateUserSubmit()">
                    Update Employee
                </button>
            </div>
        </div>
    </div>

    <!-- Create Milestone Modal -->
    <div class="modal-overlay" id="createMilestoneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-flag"></i> Create Milestone</h3>
                <button class="modal-close" onclick="closeModal('createMilestoneModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createMilestoneForm">
                    <input type="hidden" id="milestoneProjectId" />
                    <div class="form-group">
                        <label>Project</label>
                        <input type="text" class="form-control" id="milestoneProjectName" readonly />
                    </div>
                    <div class="form-group">
                        <label>Milestone Name *</label>
                        <input type="text" class="form-control" id="milestoneName" required
                            placeholder="Enter milestone name" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="milestoneDescription"
                            placeholder="Enter milestone description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" class="form-control" id="milestoneDueDate" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createMilestoneModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="createMilestone()">
                    <i class="fas fa-plus"></i> Create Milestone
                </button>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="modal-overlay" id="createTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tasks"></i> Create Task</h3>
                <button class="modal-close" onclick="closeModal('createTaskModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <input type="hidden" id="taskProjectId" />
                    <div class="form-group">
                        <label>Project</label>
                        <input type="text" class="form-control" id="taskProjectName" readonly />
                    </div>
                    <div class="form-group">
                        <label>Milestone</label>
                        <select class="form-control" id="taskMilestone">
                            <option value="">
                                Select Milestone (Optional)
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Task Title *</label>
                        <input type="text" class="form-control" id="taskTitle" required
                            placeholder="Enter task title" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="taskDescription"
                            placeholder="Enter task description"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Assign To</label>
                            <select class="form-control" id="taskAssignee">
                                <option value="">Select Team Member</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select class="form-control" id="taskPriority">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>
                                    Medium
                                </option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Deadline</label>
                        <input type="date" class="form-control" id="taskDeadline" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createTaskModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="createTask()">
                    <i class="fas fa-plus"></i> Create Task
                </button>
            </div>
        </div>
    </div>

    <!-- Task History Modal -->
    <div class="modal-overlay" id="taskHistoryModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Task History</h3>
                <button class="modal-close" onclick="closeModal('taskHistoryModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="taskHistoryContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Hierarchy Modal -->
    <div class="modal-overlay" id="hierarchyModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-sitemap"></i> User Hierarchy</h3>
                <button class="modal-close" onclick="closeModal('hierarchyModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="hierarchyContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div class="modal-overlay" id="projectDetailModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-folder-open"></i>
                    <span id="projectDetailTitle">Project Details</span>
                </h3>
                <button class="modal-close" onclick="closeModal('projectDetailModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="projectDetailContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectDetailModal')">
                    Close
                </button>
                <button class="btn btn-success" id="btnCreateMilestone" onclick="openCreateMilestoneFromProject()">
                    <i class="fas fa-flag"></i> Create Milestone
                </button>
                <button class="btn btn-primary" id="btnCreateTask" onclick="openCreateTaskFromProject()">
                    <i class="fas fa-plus"></i> Create Task
                </button>
            </div>
        </div>
    </div>

    <!-- Add Team Member Modal -->
    <div class="modal-overlay" id="addTeamMemberModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-user-plus"></i>
                    <span id="teamMemberModalTitle">Add Team Member to Project</span>
                </h3>
                <button class="modal-close" onclick="closeModal('addTeamMemberModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4>Select Team Member</h4>
                    <div id="teamMemberError" class="alert alert-danger" style="display: none; margin-bottom: 16px;">
                    </div>

                    <form id="addTeamMemberForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Employee/Team Member *</label>
                                <select class="form-control" id="teamMemberSelect" required>
                                    <option value="">Select a team member</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>User Type</label>
                                <select class="form-control" id="teamMemberTypeSelect">
                                    <option value="">Select user type (Optional)</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Existing Team Members Section -->
                <div class="form-section" style="margin-top: 24px;">
                    <h4>Selected Team Members</h4>
                    <div id="existingTeamMembersContainer" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No members selected
                            yet</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addTeamMemberModal')">
                    Back
                </button>
                <button class="btn btn-primary" onclick="submitAddTeamMember()">
                    <i class="fas fa-plus"></i> Add & Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        /* ========== IMPORTANT GLOBAL FIXES ========== */
        // Force all fetch() calls to include same-origin credentials so session cookie auth works.
        (function () {
            const _fetch = window.fetch.bind(window);
            window.fetch = function (input, init = {}) {
                init = init || {};
                // do not override if explicitly set by code
                if (!init.credentials) init.credentials = 'same-origin';
                return _fetch(input, init);
            };
        })();

        let projects = [];
        let tasks = [];
        let users = [];
        let userTypes = [];
        let activities = [];
        let currentProjectId = null;

        // Initialize dashboard when DOM loads
        document.addEventListener("DOMContentLoaded", function () {
            initializeDashboard();
            setupTabListeners();
            loadCoordinators();
            loadUsers();
            loadUserTypesForForm();
            setupModalListeners();
        });

        // Setup modal overlay click listeners
        function setupModalListeners() {
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function (e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        }

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                // Show loading state
                document.querySelectorAll('.loading-spinner').forEach(spinner => {
                    spinner.style.display = 'flex';
                });

                const results = await Promise.allSettled([
                    loadDashboardStats(),
                    loadProjects(),
                    loadActiveTasks(),
                    loadPendingTasks(),
                    loadOverdueTasks(),
                    loadCompletedTasks(),
                    loadActivities(),
                    loadAllUsersCount()
                ]);

                // Handle any failed promises
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        console.error(`Failed to load data ${index}:`, result.reason);
                    }
                });

                // Hide loading spinners
                setTimeout(() => {
                    document.querySelectorAll('.loading-spinner').forEach(spinner => {
                        spinner.style.display = 'none';
                    });
                }, 500);

            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showToast('Error loading dashboard data. Please refresh the page.', 'error');
            }
        }

        // Theme Toggle Logic
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-toggle i');
            if (icon) {
                if (theme === 'dark') {
                    icon.className = 'fas fa-sun';
                } else {
                    icon.className = 'fas fa-moon';
                }
            }
        }

        // Initialize Theme
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // Wait for DOM to update icon
            document.addEventListener('DOMContentLoaded', () => {
                updateThemeIcon(savedTheme);
            });
        })();

        // Get headers for API requests (includes CSRF token when available)
        function getHeaders() {
            const headers = { "Content-Type": "application/json" };
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.content) {
                headers['X-CSRF-Token'] = meta.content;
            }
            return headers;
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch("/api/admin/dashboard/stats", {
                    headers: getHeaders(),
                });

                if (!response.ok) {
                    // show empty stats and notify
                    document.getElementById("stat-projects").textContent = 0;
                    document.getElementById("stat-active-tasks").textContent = 0;
                    document.getElementById("stat-pending").textContent = 0;
                    document.getElementById("stat-overdue").textContent = 0;
                    document.getElementById("stat-completed").textContent = 0;
                    document.getElementById("stat-users").textContent = 0;
                    showToast('Unable to load dashboard stats (auth or server error).', 'warning');
                    return;
                }

                const stats = await response.json();

                document.getElementById("stat-projects").textContent =
                    stats.active_projects || 0;
                document.getElementById("stat-active-tasks").textContent =
                    stats.active_tasks || 0;
                document.getElementById("stat-pending").textContent =
                    stats.pending_approvals || 0;
                document.getElementById("stat-overdue").textContent =
                    stats.overdue_tasks || 0;
                document.getElementById("stat-completed").textContent =
                    stats.completed_tasks || 0;
                document.getElementById("stat-users").textContent =
                    stats.total_users || 0;
                document.getElementById("stat-usertypes").textContent =
                    stats.total_usertypes || 0;

                document.getElementById("nav-projects-count").textContent =
                    stats.active_projects || 0;
                document.getElementById("nav-overdue-count").textContent =
                    stats.overdue_tasks || 0;
            } catch (error) {
                console.error("Error loading stats:", error);
                showToast('Failed to load dashboard stats', 'error');
            }
        }

        // Load all users count
        async function loadAllUsersCount() {
            try {
                const response = await fetch('/api/users', {
                    headers: getHeaders(),
                });

                if (response.ok) {
                    const list = await response.json();
                    document.getElementById('stat-users').textContent = Array.isArray(list) ? list.length : 0;
                }
            } catch (error) {
                console.error('Error loading users count:', error);
            }
        }

        // Load projects
        async function loadProjects() {
            const loading = document.getElementById("projects-loading");
            const grid = document.getElementById("projects-grid");

            try {
                const response = await fetch(
                    "/api/dashboard/live-progress",
                    {
                        headers: getHeaders(),
                    },
                );

                if (!response.ok) {
                    throw new Error("Failed to load projects");
                }

                const data = await response.json();
                // server returns either {projects: [...] } or an array
                const serverProjects = Array.isArray(data) ? data : (data.projects || []);
                projects = serverProjects;

                loading.style.display = "none";

                if (projects.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <i class="fas fa-folder-open"></i>
                            <h4>No Active Projects</h4>
                            <p>Create your first project to get started</p>
                            <button class="btn btn-primary" onclick="openModal('createProjectModal')">
                                <i class="fas fa-plus"></i> Create Project
                            </button>
                        </div>
                    `;
                    document.getElementById("tab-projects-count").textContent = 0;
                    document.getElementById("nav-projects-count").textContent = 0;
                    return;
                }

                grid.innerHTML = projects
                    .map((project) => createProjectCard(project))
                    .join("");
                document.getElementById("tab-projects-count").textContent =
                    projects.length;
                document.getElementById("nav-projects-count").textContent = projects.length;
            } catch (error) {
                console.error("Error loading projects:", error);
                loading.innerHTML =
                    '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h4>Error loading projects</h4></div>';
                showToast('Error loading projects from server', 'error');
            }
        }

        // Create project card
        function createProjectCard(project) {
            const progress = project.progress || 0;
            const progressClass =
                progress < 33 ? "low" : progress < 66 ? "medium" : "high";
            const deadline = project.deadline
                ? new Date(project.deadline).toLocaleDateString()
                : "No deadline";
            const isOverdue =
                project.deadline &&
                new Date(project.deadline) < new Date() &&
                project.status !== "Completed";

            const id = project.id || 0;
            const title = escapeHtml(project.title || 'Untitled');
            const creator = escapeHtml(project.creator_name || project.created_by || 'Unassigned');
            const description = escapeHtml(project.description || 'No description');

            return `
                <div class="project-card" onclick="openProjectDetail(${id})">
                    <div class="project-header">
                        <div>
                            <h4 class="project-title">${title}</h4>
                            <span class="project-coordinator">
                                <i class="fas fa-user"></i> ${creator}
                            </span>
                        </div>
                        <span class="project-priority priority-${(project.health_status || "warning").toLowerCase()}">${escapeHtml(project.status || "Active")}</span>
                    </div>
                    <p class="project-description">${description}</p>
                    <div class="project-progress">
                        <div class="progress-header">
                            <span class="progress-label">Progress</span>
                            <span class="progress-value">${progress}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill ${progressClass}" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <div class="project-meta">
                        <span class="meta-item ${isOverdue ? "overdue" : ""}">
                            <i class="fas fa-calendar"></i> ${deadline}
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-tasks"></i> ${project.completed_tasks || 0}/${project.total_tasks || 0} Tasks
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-users"></i> ${project.team_size || 0} Members
                        </span>
                    </div>
                </div>
            `;
        }

        // Load active tasks
        async function loadActiveTasks() {
            const loading = document.getElementById("active-tasks-loading");
            const table = document.getElementById("active-tasks-table");
            const tbody = document.getElementById("active-tasks-body");

            try {
                const response = await fetch(
                    "/api/admin/tasks?status=In Progress",
                    {
                        headers: getHeaders(),
                    },
                );

                if (!response.ok) {
                    throw new Error("Failed to load tasks");
                }

                const data = await response.json();
                const activeTasks = Array.isArray(data)
                    ? data
                    : data.tasks || [];

                loading.style.display = "none";
                table.style.display = "table";

                if (activeTasks.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="7" class="text-center">No active tasks</td></tr>';
                } else {
                    tbody.innerHTML = activeTasks
                        .map((task) => createTaskRow(task, "active"))
                        .join("");
                }

                document.getElementById("tab-active-count").textContent =
                    activeTasks.length;
                document.getElementById("stat-active-tasks").textContent = activeTasks.length;
            } catch (error) {
                console.error("Error loading active tasks:", error);
                loading.innerHTML =
                    '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h4>Error loading tasks</h4></div>';
            }
        }

        // Load pending tasks
        async function loadPendingTasks() {
            const loading = document.getElementById(
                "pending-tasks-loading",
            );
            const table = document.getElementById("pending-tasks-table");
            const tbody = document.getElementById("pending-tasks-body");

            try {
                const response = await fetch(
                    "/api/admin/tasks?status=Pending",
                    {
                        headers: getHeaders(),
                    },
                );

                if (!response.ok) {
                    throw new Error("Failed to load tasks");
                }

                const data = await response.json();
                const pendingTasks = Array.isArray(data)
                    ? data
                    : data.tasks || [];

                loading.style.display = "none";
                table.style.display = "table";

                if (pendingTasks.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="7" class="text-center">No pending tasks</td></tr>';
                } else {
                    tbody.innerHTML = pendingTasks
                        .map((task) => createTaskRow(task, "pending"))
                        .join("");
                }

                document.getElementById("tab-pending-count").textContent =
                    pendingTasks.length;
                document.getElementById("stat-pending").textContent = pendingTasks.length;
            } catch (error) {
                console.error("Error loading pending tasks:", error);
                loading.innerHTML =
                    '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h4>Error loading tasks</h4></div>';
            }
        }

        // Load overdue tasks
        async function loadOverdueTasks() {
            const loading = document.getElementById(
                "overdue-tasks-loading",
            );
            const table = document.getElementById("overdue-tasks-table");
            const tbody = document.getElementById("overdue-tasks-body");

            try {
                const response = await fetch(
                    "/api/admin/dashboard/overdue-items",
                    {
                        headers: getHeaders(),
                    },
                );

                if (!response.ok) {
                    throw new Error("Failed to load overdue tasks");
                }

                const data = await response.json();
                const overdueTasks = data.overdue_tasks || [];

                loading.style.display = "none";
                table.style.display = "table";

                if (overdueTasks.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="7" class="text-center">No overdue tasks</td></tr>';
                } else {
                    tbody.innerHTML = overdueTasks
                        .map((task) => createOverdueTaskRow(task))
                        .join("");
                }

                document.getElementById("tab-overdue-count").textContent =
                    overdueTasks.length;
                document.getElementById("stat-overdue").textContent = overdueTasks.length;
            } catch (error) {
                console.error("Error loading overdue tasks:", error);
                loading.innerHTML =
                    '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h4>Error loading tasks</h4></div>';
            }
        }

        // Load completed tasks
        async function loadCompletedTasks() {
            const loading = document.getElementById(
                "completed-tasks-loading",
            );
            const table = document.getElementById("completed-tasks-table");
            const tbody = document.getElementById("completed-tasks-body");

            try {
                const response = await fetch(
                    "/api/admin/tasks?status=Completed",
                    {
                        headers: getHeaders(),
                    },
                );

                if (!response.ok) {
                    throw new Error("Failed to load tasks");
                }

                const data = await response.json();
                const completedTasks = Array.isArray(data)
                    ? data
                    : data.tasks || [];

                loading.style.display = "none";
                table.style.display = "table";

                if (completedTasks.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="6" class="text-center">No completed tasks</td></tr>';
                } else {
                    tbody.innerHTML = completedTasks
                        .map((task) => createCompletedTaskRow(task))
                        .join("");
                }

                document.getElementById("tab-completed-count").textContent =
                    completedTasks.length;
                document.getElementById("stat-completed").textContent = completedTasks.length;
            } catch (error) {
                console.error("Error loading completed tasks:", error);
                loading.innerHTML =
                    '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h4>Error loading tasks</h4></div>';
            }
        }

        // Create task row
        function createTaskRow(task, type) {
            const deadline = task.deadline
                ? new Date(task.deadline).toLocaleDateString()
                : "No deadline";
            const priorityClass = (task.priority || "medium").toLowerCase();
            const statusClass = (task.status || "pending")
                .toLowerCase()
                .replace(" ", "-");

            return `
                <tr>
                    <td>
                        <div class="task-title-cell">
                            <span class="task-type-icon task"><i class="fas fa-check"></i></span>
                            <div>
                                <strong>${escapeHtml(task.title)}</strong>
                                <div class="task-id">TASK-${task.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${escapeHtml(task.project_name || task.project_title || "N/A")}</td>
                    <td>
                        <div class="avatar-group">
                            <span class="avatar">${getInitials(task.assigned_to_name || "UA")}</span>
                        </div>
                        <small>${escapeHtml(task.assigned_to_name || "Unassigned")}</small>
                    </td>
                    <td>${deadline}</td>
                    <td><span class="status-badge priority-${priorityClass}">${task.priority || "Medium"}</span></td>
                    <td><span class="status-badge ${statusClass}">${task.status || "Pending"}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewTaskHistory(${task.id})">
                            <i class="fas fa-history"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Create overdue task row
        function createOverdueTaskRow(task) {
            const deadline = task.deadline
                ? new Date(task.deadline).toLocaleDateString()
                : "No deadline";
            const daysOverdue = task.days_overdue || 0;
            const priorityClass = (task.priority || "medium").toLowerCase();

            return `
                <tr class="overdue-row">
                    <td>
                        <div class="task-title-cell">
                            <span class="task-type-icon bug"><i class="fas fa-exclamation"></i></span>
                            <div>
                                <strong>${escapeHtml(task.title)}</strong>
                                <div class="task-id">TASK-${task.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${escapeHtml(task.project_name || "N/A")}</td>
                    <td>
                        <div class="avatar-group">
                            <span class="avatar">${getInitials(task.assigned_to_name || "UA")}</span>
                        </div>
                        <small>${escapeHtml(task.assigned_to_name || "Unassigned")}</small>
                    </td>
                    <td>${deadline}</td>
                    <td><span class="status-badge overdue">${daysOverdue} days overdue</span></td>
                    <td><span class="status-badge priority-${priorityClass}">${task.priority || "Medium"}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewTaskHistory(${task.id})">
                            <i class="fas fa-history"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Create completed task row
        function createCompletedTaskRow(task) {
            const completedOn = task.completed_at
                ? new Date(task.completed_at).toLocaleDateString()
                : "N/A";
            const priorityClass = (task.priority || "medium").toLowerCase();

            return `
                <tr>
                    <td>
                        <div class="task-title-cell">
                            <span class="task-type-icon story"><i class="fas fa-check"></i></span>
                            <div>
                                <strong>${escapeHtml(task.title)}</strong>
                                <div class="task-id">TASK-${task.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${escapeHtml(task.project_name || task.project_title || "N/A")}</td>
                    <td>
                        <div class="avatar-group">
                            <span class="avatar">${getInitials(task.assigned_to_name || "UA")}</span>
                        </div>
                        <small>${escapeHtml(task.assigned_to_name || "Unassigned")}</small>
                    </td>
                    <td>${completedOn}</td>
                    <td><span class="status-badge priority-${priorityClass}">${task.priority || "Medium"}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewTaskHistory(${task.id})">
                            <i class="fas fa-history"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Load activities
        async function loadActivities() {
            const activityList = document.getElementById("activity-list");

            try {
                const response = await fetch(
                    "/api/admin/dashboard/recent-actions",
                    {
                        headers: getHeaders(),
                    },
                );

                if (!response.ok) {
                    throw new Error("Failed to load activities");
                }

                activities = await response.json();

                if (activities.length === 0) {
                    activityList.innerHTML =
                        '<div class="empty-state"><i class="fas fa-bell-slash"></i><p>No recent activity</p></div>';
                    return;
                }

                activityList.innerHTML = activities
                    .slice(0, 50)
                    .map((activity) => {
                        const time = activity.created_at
                            ? new Date(activity.created_at).toLocaleString()
                            : "";
                        const iconClass = getActivityIconClass(
                            activity.activity_type,
                        );

                        return `
                        <div class="activity-item">
                            <div class="activity-icon ${iconClass}">
                                <i class="${activity.icon_class || "fas fa-info"}"></i>
                            </div>
                            <div class="activity-content">
                                <p class="activity-text">
                                    <strong>${escapeHtml(activity.username || "System")}</strong> ${escapeHtml(activity.description || activity.activity_type)}
                                </p>
                                <span class="activity-time">${time}</span>
                            </div>
                        </div>
                    `;
                    })
                    .join("");
            } catch (error) {
                console.error("Error loading activities:", error);
                activityList.innerHTML =
                    '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading activities</p></div>';
            }
        }

        // Get activity icon class
        function getActivityIconClass(type) {
            const iconMap = {
                task_created: "task",
                task_completed: "task",
                task_updated: "task",
                milestone_created: "milestone",
                milestone_completed: "milestone",
                project_created: "project",
                daily_report_created: "report",
            };
            return iconMap[type] || "task";
        }

        // Load coordinators
        async function loadCoordinators() {
            try {
                const response = await fetch("/api/users", {
                    headers: getHeaders(),
                });

                if (!response.ok) {
                    throw new Error("Failed to load users");
                }

                const allUsers = await response.json();

                const coordinators = allUsers.filter(
                    (u) =>
                        u.user_role &&
                        (u.user_role
                            .toLowerCase()
                            .includes("coordinator") ||
                            u.user_role.toLowerCase().includes("admin") ||
                            u.user_role.toLowerCase().includes("manager")),
                );

                const select =
                    document.getElementById("projectCoordinator");
                if (select) {
                    select.innerHTML =
                        '<option value="">Select Coordinator</option>';
                    coordinators.forEach((user) => {
                        select.innerHTML += `<option value="${user.id}">${escapeHtml(user.username)} (${escapeHtml(user.user_role || "User")})</option>`;
                    });
                }
            } catch (error) {
                console.error("Error loading coordinators:", error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch("/api/users", {
                    headers: getHeaders(),
                });

                if (!response.ok) {
                    throw new Error("Failed to load users");
                }

                users = await response.json();

                const assigneeSelect =
                    document.getElementById("taskAssignee");
                if (assigneeSelect) {
                    assigneeSelect.innerHTML =
                        '<option value="">Select Team Member</option>';
                    users.forEach((user) => {
                        assigneeSelect.innerHTML += `<option value="${user.id}">${escapeHtml(user.username)}</option>`;
                    });
                }

                const teamSelect = document.getElementById("teamMemberSelect");
                if (teamSelect) {
                    teamSelect.innerHTML = '<option value="">Select a team member</option>';
                    users.forEach((user) => {
                        teamSelect.innerHTML += `<option value="${user.id}">${escapeHtml(user.username)}</option>`;
                    });
                }

            } catch (error) {
                console.error("Error loading users:", error);
            }
        }

        // Open Users Modal
        async function openUsersModal() {
            openModal('usersModal');
            await loadAllUsersWithDetails();
        }

        // Load all users with details
        async function loadAllUsersWithDetails() {
            const content = document.getElementById('usersModalContent');
            content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                // Try to fetch from API
                const response = await fetch('/api/admin/users', {
                    headers: getHeaders(),
                });

                if (!response.ok) {
                    // If API fails, show informative empty state
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>Unable to load users</h4>
                            <p>Please ensure you are logged in with admin access.</p>
                        </div>
                    `;
                    return;
                }

                const usersData = await response.json();
                users = usersData || [];

                if (users.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No Users Found</h4>
                            <p>Create your first user to get started</p>
                            <button class="btn btn-primary" onclick="openCreateUserModal()">
                                <i class="fas fa-user-plus"></i> Create User
                            </button>
                        </div>
                    `;
                    return;
                }

                // Update stats
                document.getElementById('stat-users').textContent = users.length;

                // Display users with permissions (simplified)
                content.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>All Users (${users.length})</h4>
                        <button class="btn btn-sm btn-primary" onclick="openCreateUserModal()">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>User Type</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                ${users.map(user => createUserRowForTable(user)).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading users:', error);
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4>Error Loading Users</h4>
                        <p>${escapeHtml(String(error))}</p>
                    </div>
                `;
            }
        }

        function createUserRowForTable(user) {
            return `
                <tr>
                    <td>${user.id || 'N/A'}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <span class="avatar">${getInitials(user.username)}</span>
                            <strong>${escapeHtml(user.username)}</strong>
                        </div>
                    </td>
                    <td>${escapeHtml(user.email || 'N/A')}</td>
                    <td>${escapeHtml(user.user_role || 'User')}</td>
                    <td>${user.created_at ? escapeHtml(user.created_at) : ''}</td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline" onclick="viewUserDetails(${user.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="openEditUserModal(${user.id})" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id}, '${escapeHtml(user.username)}')" title="Delete User">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // View user details
        async function viewUserDetails(userId) {
            openModal('userDetailModal');
            const content = document.getElementById('userDetailContent');
            content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    headers: getHeaders(),
                });

                if (!response.ok) {
                    // fallback to a simple representation from local users array
                    const user = users.find(u => u.id == userId) || {
                        id: userId,
                        username: 'User ' + userId,
                        email: 'user' + userId + '@example.com',
                        status: 'active',
                        user_role: 'User',
                        permissions: {}
                    };

                    content.innerHTML = createUserDetailContent(user);
                    return;
                }

                const user = await response.json();
                content.innerHTML = createUserDetailContent(user);
            } catch (error) {
                console.error('Error loading user details:', error);
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4>Error Loading User Details</h4>
                        <p>${escapeHtml(String(error))}</p>
                    </div>
                `;
            }
        }

        // Create user detail content
        function createUserDetailContent(user) {
            return `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="avatar-large mb-3">
                            ${getInitials(user.username)}
                        </div>
                        <h4>${escapeHtml(user.username)}</h4>
                        <span class="status-badge ${getUserTypeClass(user.user_role || user.user_type || 'User')}">
                            ${escapeHtml(user.user_role || user.user_type || 'User')}
                        </span>
                    </div>
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Email:</strong> ${escapeHtml(user.email || 'N/A')}</p>
                                        <p><strong>User ID:</strong> ${user.id || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> <span class="status-badge ${user.status === 'active' ? 'completed' : 'pending'}">${user.status === 'active' ? 'Active' : 'Inactive'}</span></p>
                                        <p><strong>Joined:</strong> ${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5>Permissions</h5>
                            </div>
                            <div class="card-body">
                                ${renderUserPermissions(user)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render user permissions
        function renderUserPermissions(user) {
            if (!user.permissions && !user.user_role_permissions) {
                return `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-shield-alt fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p>No permissions assigned to this user.</p>
                    </div>`;
            }

            let html = '<div style="display: grid; gap: 15px;">';

            // If we have the structured permissions object from API
            if (user.permissions && Object.keys(user.permissions).length > 0) {
                Object.entries(user.permissions).forEach(([module, actions]) => {
                    const enabledActions = typeof actions === 'object'
                        ? Object.keys(actions).filter(action => actions[action])
                        : [];

                    if (enabledActions.length > 0) {
                        html += `
                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary);">
                                <strong style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); display: block; margin-bottom: 8px;">
                                    <i class="fas fa-folder-open me-1"></i> ${escapeHtml(module)}
                                </strong>
                                <div class="permission-tags">
                                    ${enabledActions.map(action => `
                                        <span class="permission-tag" style="background: #e1e7f0; color: #172b4d;">
                                            ${escapeHtml(action.replace(/_/g, ' '))}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
            } else if (user.user_role_permissions) {
                // Fallback for simple string permissions
                html += `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary);">
                        <strong style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); display: block; margin-bottom: 8px;">
                            <i class="fas fa-user-shield me-1"></i> Role Permissions
                        </strong>
                        <p style="font-size: 13px; margin: 0;">${escapeHtml(user.user_role_permissions)}</p>
                    </div>
                `;
            }

            html += '</div>';

            // Add a note about where permissions come from if possible
            if (user.user_role) {
                html += `
                    <div style="margin-top: 15px; font-size: 11px; color: var(--text-secondary); font-style: italic;">
                        <i class="fas fa-info-circle me-1"></i> These permissions are inherited from the <strong>${escapeHtml(user.user_role)}</strong> role plus any direct assignments.
                    </div>
                `;
            }

            return html;
        }

        // Toggle user status
        async function toggleUserStatus(userId, currentStatus) {
            if (!confirm(`Are you sure you want to ${currentStatus === 'active' ? 'deactivate' : 'activate'} this user?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        status: currentStatus === 'active' ? 'inactive' : 'active'
                    })
                });

                if (response.ok) {
                    showToast(`User ${currentStatus === 'active' ? 'deactivated' : 'activated'} successfully!`, 'success');
                    await loadAllUsersWithDetails();
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to update user status', 'error');
                }
            } catch (error) {
                showToast('Error updating user status', 'error');
            }
        }

        // Delete User
        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || 'Failed to delete user');
                }

                showToast(`User "${username}" deleted successfully`, 'success');

                // Reload the users list
                await loadAllUsersWithDetails();

            } catch (error) {
                showToast(error.message || 'Error deleting user', 'error');
            }
        }

        // Open Edit User Modal
        async function openEditUserModal(userId) {
            try {
                // Fetch user details
                const response = await fetch(`/api/users/${userId}`, {
                    headers: getHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load user details');
                }

                const user = await response.json();

                // Populate update form
                document.getElementById('updateUsrId').value = user.id;
                document.getElementById('updateUsrUsername').value = user.username;
                document.getElementById('updateUsrEmail').value = user.email;

                // Set user type
                if (user.user_type_id) {
                    document.getElementById('updateUsrUserType').value = user.user_type_id;
                }

                // Open the modal
                openModal('updateUserModal');

            } catch (error) {
                showToast(error.message || 'Error loading user data', 'error');
            }
        }

        // Edit user
        async function editUser(userId) {
            try {
                // Find user in current users list
                const user = users.find(u => u.id == userId);
                if (!user) {
                    showToast('User not found', 'error');
                    return;
                }

                // Populate update form
                document.getElementById('updateUsrId').value = user.id;
                document.getElementById('updateUsrUsername').value = user.username;
                document.getElementById('updateUsrEmail').value = user.email;

                // Set user type
                if (user.user_type_id) {
                    document.getElementById('updateUsrUserType').value = user.user_type_id;
                } else {
                    await loadUserTypesForForm();
                }

                // Set permissions checkboxes (best-effort)
                if (user.permissions) {
                    Object.entries(user.permissions).forEach(([module, actions]) => {
                        if (typeof actions === 'object') {
                            Object.entries(actions).forEach(([action, enabled]) => {
                                const checkbox = document.querySelector(`#updateUserModal input[data-module="${module}"][data-action="${action}"]`);
                                if (checkbox) {
                                    checkbox.checked = enabled === true;
                                }
                            });
                        }
                    });
                }

                // Open update modal
                openModal('updateUserModal');
            } catch (error) {
                showToast('Error loading user data', 'error');
            }
        }

        // Create Project with Team Members
        async function createProject(e) {
            if (e && typeof e.preventDefault === "function") {
                e.preventDefault();
            }

            const name = document
                .getElementById("projectName")
                .value.trim();
            const description = document
                .getElementById("projectDescription")
                .value.trim();
            const deadline =
                document.getElementById("projectDeadline").value;
            const reportingTime =
                document.getElementById("projectReportingTime").value ||
                "09:00";

            if (!name || !deadline) {
                showToast("Please fill in required fields", "error");
                return;
            }

            try {
                // Get selected team members from checkboxes
                const selectedTeamMembers = Array.from(
                    document.querySelectorAll(
                        '#projectTeamContainer input[type="checkbox"]:checked',
                    ),
                ).map((cb) => parseInt(cb.value)).filter(Boolean);

                // Validate that at least one team member is selected
                if (selectedTeamMembers.length === 0) {
                    showToast("Please assign at least one team member to the project", "error");
                    return;
                }

                const response = await fetch("/api/employee/projects", {
                    method: "POST",
                    headers: getHeaders(),
                    body: JSON.stringify({
                        title: name,
                        description: description,
                        deadline: deadline,
                        reporting_time: reportingTime,
                        team_members: selectedTeamMembers,
                    }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(
                        error.error || `Failed to create project (${response.status})`,
                    );
                }

                const resData = await response.json();
                showToast("Project created successfully!", "success");

                // Reset form and close modal
                closeModal("createProjectModal");
                document.getElementById("createProjectForm").reset();

                // Clear team member selections
                document.querySelectorAll('#projectTeamContainer input[type="checkbox"]').forEach(cb => cb.checked = false);

                // Reload data
                await loadProjects();
                await loadDashboardStats();

            } catch (error) {
                showToast(error.message || "Error creating project", "error");
            }
        }

        // Create UserType
        async function createUserTypeSubmit() {
            const userRole = document.getElementById('typRole').value.trim();
            const description = document.getElementById('typDescription').value.trim();
            const errorDiv = document.getElementById('usertypeError');

            if (!userRole || userRole.length < 3) {
                errorDiv.innerHTML = '<div class="alert alert-danger">User role must be at least 3 characters</div>';
                return;
            }

            const selectedPermissions = Array.from(document.querySelectorAll('#createUserTypeModal .perm-checkbox:checked')).map(cb => cb.value);

            try {
                const response = await fetch('/api/usertypes', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        user_role: userRole,
                        description: description,
                        permissions: selectedPermissions
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Error creating user type'}</div>`;
                    return;
                }

                showToast('User type created successfully!', 'success');
                closeModal('createUserTypeModal');
                document.getElementById('createUserTypeForm').reset();
                await loadUserTypesForForm();
                await loadDashboardStats(); // Update dashboard stats after creation

                // show usertype list to verify creation
                setTimeout(() => openUsertypeListModal(), 400);

            } catch (error) {
                console.error('Error creating user type:', error);
                errorDiv.innerHTML = '<div class="alert alert-danger">Error creating user type</div>';
            }
        }

        // ------------------------------------------------------------------
        // User Type Management Functions
        // ------------------------------------------------------------------

        let allUserTypes = []; // Store user types globally

        // Load User Types List
        async function openUsertypeListModal() {
            openModal('usertypeListModal');
            document.getElementById('usertypesTableBody').innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner" style="margin: 20px auto;"></div></td></tr>';
            await loadUsertypesList();
        }

        async function loadUsertypesList() {
            try {
                const response = await fetch('/api/usertypes', { headers: getHeaders() });
                if (!response.ok) throw new Error('Failed to fetch user types');

                allUserTypes = await response.json(); // Store in global variable

                const tbody = document.getElementById('usertypesTableBody');
                if (allUserTypes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No user types found.</td></tr>';
                    return;
                }

                tbody.innerHTML = allUserTypes.map(ut => `
                    <tr>
                        <td><strong>${escapeHtml(ut.user_role)}</strong></td>
                        <td>${escapeHtml(ut.description || '-')}</td>
                        <td>
                            <div class="permission-tags">
                                <span class="permission-tag" style="background: var(--primary-light); color: var(--primary);">
                                    ${ut.permissions ? ut.permissions.length : 0} Permissions
                                </span>
                            </div>
                        </td>
                        <td>${new Date(ut.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-info" title="View" style="color: white;" onclick="viewUsertype(${ut.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" title="Edit" onclick="editUsertype(${ut.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" title="Delete" onclick="deleteUsertype(${ut.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error("Error loading user types", error);
                document.getElementById('usertypesTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>`;
            }
        }

        // View User Type
        function viewUsertype(id) {
            const ut = allUserTypes.find(t => t.id === id);
            if (!ut) return;

            document.getElementById('viewTypRole').textContent = ut.user_role;
            document.getElementById('viewTypDescription').textContent = ut.description || 'No description provided';

            const permContainer = document.getElementById('viewPermissionsList');
            if (ut.permissions && ut.permissions.length > 0) {
                // Group permissions by module (first part of the string before _)
                const grouped = {};
                ut.permissions.forEach(p => {
                    if (!p) return;
                    const parts = p.split('_');
                    const mod = parts[0];
                    const action = parts.slice(1).join(' ').replace(/_/g, ' ');
                    if (!grouped[mod]) grouped[mod] = [];
                    grouped[mod].push(action || p);
                });

                let html = '<div style="display: grid; gap: 12px; margin-top: 10px;">';
                for (const [mod, actions] of Object.entries(grouped)) {
                    html += `
                        <div style="background: var(--bg-secondary); padding: 10px; border-radius: 6px;">
                            <strong style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); display: block; margin-bottom: 5px;">${mod}</strong>
                            <div class="permission-tags">
                                ${actions.map(a => `<span class="permission-tag" style="background: #e1e7f0; color: #172b4d;">${a}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                permContainer.innerHTML = html;
            } else {
                permContainer.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-shield-alt fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p>No permissions assigned to this user type.</p>
                    </div>`;
            }

            openModal('viewUserTypeModal');
        }

        // Edit User Type
        function editUsertype(id) {
            const ut = allUserTypes.find(t => t.id === id);
            if (!ut) return;

            document.getElementById('editTypId').value = ut.id;
            document.getElementById('editTypRole').value = ut.user_role;
            document.getElementById('editTypDescription').value = ut.description || '';
            document.getElementById('updateUsertypeError').innerHTML = '';

            // Reset all checkboxes first
            document.querySelectorAll('#updateUserTypeModal .perm-checkbox').forEach(cb => cb.checked = false);

            // Check assigned permissions
            if (ut.permissions) {
                ut.permissions.forEach(perm => {
                    // Match value: e.g. "ADMIN_VIEW_HIERARCHY"
                    // We need to look for checkbox with this value
                    const cb = document.querySelector(`#updateUserTypeModal .perm-checkbox[value="${perm}"]`);
                    if (cb) {
                        cb.checked = true;
                    } else {
                        // Fallback: maybe perm was stored differently or module/action split issues
                        // Try to fuzzy match or just ignore
                    }
                });
            }

            // Close list modal and open edit modal
            closeModal('usertypeListModal');
            openModal('updateUserTypeModal');
        }

        // Submit Update
        async function updateUserTypeSubmit() {
            const id = document.getElementById('editTypId').value;
            const userRole = document.getElementById('editTypRole').value.trim();
            const description = document.getElementById('editTypDescription').value.trim();
            const errorDiv = document.getElementById('updateUsertypeError');

            if (!userRole) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Role name is required</div>';
                return;
            }

            // Get permissions from checkboxes
            const selectedPermissions = Array.from(document.querySelectorAll('#updateUserTypeModal .perm-checkbox:checked')).map(cb => cb.value);

            try {
                const response = await fetch(`/api/usertypes/${id}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        user_role: userRole,
                        description: description,
                        permissions: selectedPermissions
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Update failed'}</div>`;
                    return;
                }

                showToast('User type updated successfully', 'success');
                closeModal('updateUserTypeModal');

                // Refresh list and stats
                // Wait small delay to ensure DB update is propagated if async (sqlite is sync but good practice)
                setTimeout(() => {
                    openUsertypeListModal();
                    loadDashboardStats();
                }, 300);

            } catch (error) {
                console.error(error);
                errorDiv.innerHTML = '<div class="alert alert-danger">Error updating user type</div>';
            }
        }

        // Delete User Type
        async function deleteUsertype(id) {
            const ut = allUserTypes.find(t => t.id === id);
            const roleName = ut ? ut.user_role : 'this User Type';

            const result = await Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete the "${roleName}" user type. This cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#de350b',
                cancelButtonColor: '#5e6c84',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(`/api/usertypes/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                const data = await response.json();
                if (!response.ok) {
                    Swal.fire('Error!', data.error || 'Delete failed', 'error');
                    return;
                }

                Swal.fire(
                    'Deleted!',
                    'User type has been deleted successfully.',
                    'success'
                );
                loadUsertypesList(); // Refresh list content only
                loadDashboardStats(); // Refresh stats
            } catch (error) {
                Swal.fire('Error!', 'Something went wrong while deleting.', 'error');
            }
        }

        // Create User
        async function createUserSubmit() {
            const username = document.getElementById('usrUsername').value.trim();
            const email = document.getElementById('usrEmail').value.trim();
            const password = document.getElementById('usrPassword').value;
            const confirmPassword = document.getElementById('usrConfirmPassword').value;
            const userTypeId = document.getElementById('usrUserType').value;
            const errorDiv = document.getElementById('userError');

            errorDiv.innerHTML = '';

            if (!username || username.length < 3) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Username must be at least 3 characters</div>';
                return;
            }
            if (!email || !email.includes('@')) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Please enter a valid email address</div>';
                return;
            }
            if (!password || password.length < 8) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Password must be at least 8 characters</div>';
                return;
            }
            if (password !== confirmPassword) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Passwords do not match</div>';
                return;
            }
            if (!userTypeId) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Please select a user type</div>';
                return;
            }

            const permissions = {};
            document.querySelectorAll('#createUserModal [data-module][data-action]').forEach(checkbox => {
                if (checkbox.checked) {
                    const moduleName = checkbox.getAttribute('data-module');
                    const actionName = checkbox.getAttribute('data-action');
                    if (!permissions[moduleName]) permissions[moduleName] = {};
                    permissions[moduleName][actionName] = true;
                }
            });

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        confirm_password: confirmPassword,
                        user_type_id: parseInt(userTypeId),
                        permissions
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    errorDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                showToast('Employee created successfully!', 'success');
                closeModal('createUserModal');
                document.getElementById('createUserForm').reset();
                await loadAllUsersWithDetails();
                await loadDashboardStats();
            } catch (error) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Error creating employee</div>';
            }
        }

        // Update User
        async function updateUserSubmit() {
            const userId = document.getElementById('updateUsrId').value;
            const username = document.getElementById('updateUsrUsername').value.trim();
            const email = document.getElementById('updateUsrEmail').value.trim();
            const password = document.getElementById('updateUsrPassword').value;
            const userTypeId = document.getElementById('updateUsrUserType').value;
            const errorDiv = document.getElementById('updateUserError');

            errorDiv.innerHTML = '';

            if (!username || username.length < 3) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Username must be at least 3 characters</div>';
                return;
            }
            if (!email || !email.includes('@')) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Please enter a valid email address</div>';
                return;
            }
            if (!userTypeId) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Please select a user type</div>';
                return;
            }

            const permissions = {};
            document.querySelectorAll('#updateUserModal [data-module][data-action]').forEach(checkbox => {
                if (checkbox.checked) {
                    const moduleName = checkbox.getAttribute('data-module');
                    const actionName = checkbox.getAttribute('data-action');
                    if (!permissions[moduleName]) permissions[moduleName] = {};
                    permissions[moduleName][actionName] = true;
                }
            });

            const payload = { username, email, user_type_id: parseInt(userTypeId), permissions };
            if (password) payload.password = password;

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (!response.ok) {
                    errorDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                showToast('Employee updated successfully!', 'success');
                closeModal('updateUserModal');
                await loadAllUsersWithDetails();
            } catch (error) {
                errorDiv.innerHTML = '<div class="alert alert-danger">Error updating employee</div>';
            }
        }

        // Load User Types for dropdowns
        async function loadUserTypesForForm() {
            try {
                const response = await fetch('/api/usertypes', {
                    headers: getHeaders()
                });

                if (response.ok) {
                    const usertypes = await response.json();

                    // Update Create User form
                    const userTypeSelect = document.getElementById('usrUserType');
                    if (userTypeSelect) {
                        userTypeSelect.innerHTML = '<option value="">Select a user type</option>';
                        usertypes.forEach(ut => {
                            userTypeSelect.innerHTML += `<option value="${ut.id}">${escapeHtml(ut.user_role)}</option>`;
                        });
                    }

                    // Update Update User form
                    const updateUserTypeSelect = document.getElementById('updateUsrUserType');
                    if (updateUserTypeSelect) {
                        updateUserTypeSelect.innerHTML = '<option value="">Select a user type</option>';
                        usertypes.forEach(ut => {
                            updateUserTypeSelect.innerHTML += `<option value="${ut.id}">${escapeHtml(ut.user_role)}</option>`;
                        });
                    }

                    // Team member type select
                    const teamMemberTypeSelect = document.getElementById('teamMemberTypeSelect');
                    if (teamMemberTypeSelect) {
                        teamMemberTypeSelect.innerHTML = '<option value="">Select user type</option>';
                        usertypes.forEach(ut => {
                            teamMemberTypeSelect.innerHTML += `<option value="${ut.id}">${escapeHtml(ut.user_role)}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading user types:', error);
            }
        }

        // Setup tab listeners
        function setupTabListeners() {
            document.querySelectorAll(".tab-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                    const tabId = this.getAttribute("data-tab");
                    switchTab(tabId);
                });
            });
        }

        // Switch tab
        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll(".tab-btn").forEach((btn) => {
                btn.classList.remove("active");
                if (btn.getAttribute("data-tab") === tabId) {
                    btn.classList.add("active");
                }
            });

            // Update nav items
            document.querySelectorAll(".nav-item").forEach((item) => {
                item.classList.remove("active");
            });

            // Update tab content
            document.querySelectorAll(".tab-content").forEach((content) => {
                content.classList.remove("active");
            });

            const targetTab = document.getElementById("tab-" + tabId);
            if (targetTab) {
                targetTab.classList.add("active");
            }

            // set nav item active if it triggers this tab
            document.querySelectorAll(".nav-item").forEach((item) => {
                const on = item.getAttribute('onclick') || '';
                if (on.includes(`'${tabId}'`) || on.includes(`"${tabId}"`)) {
                    item.classList.add('active');
                }
            });
        }

        // Open modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add("active");
            } else {
                console.error(`Modal with ID '${modalId}' not found`);
            }
        }

        // Close modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove("active");
            }
        }

        // Toggle activity panel
        function toggleActivityPanel() {
            document
                .getElementById("activityPanel")
                .classList.toggle("open");
        }

        // Team Member Management Functions
        function updateTeamMemberCount() {
            const container = document.getElementById('projectTeamContainer');
            const countBadge = document.getElementById('teamMemberCount');
            if (container && countBadge) {
                const count = container.querySelectorAll('input[type="checkbox"]').length;
                countBadge.textContent = count;
                countBadge.style.background = count > 0 ? 'var(--success)' : 'var(--danger)';
            }
        }

        function removeTeamMember(button) {
            const row = button.closest('.team-member-row');
            if (row) {
                row.remove();
                updateTeamMemberCount();

                // Show empty state if no members left
                const container = document.getElementById('projectTeamContainer');
                if (container && container.querySelectorAll('.team-member-row').length === 0) {
                    container.innerHTML = `
                        <div class="team-member-row empty-state"><i class="fas fa-users"></i>
                            <div style="margin-top:8px;">No users found. Add new members.</div>
                        </div>
                    `;
                }
            }
        }

        // Utility Functions
        function escapeHtml(text) {
            if (text === null || text === undefined) return "";
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        function getInitials(name) {
            if (!name) return "UA";
            return name
                .split(" ")
                .map((n) => n[0])
                .join("")
                .substring(0, 2)
                .toUpperCase();
        }

        function showToast(message, type = "info") {
            const container = document.getElementById("toastContainer");
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        function logout() {
            localStorage.removeItem("admin_token");
            sessionStorage.removeItem("admin_token");
            fetch("/api/user/logout", { method: "POST" }).finally(() => {
                window.location.replace("/login");
            });
        }

        // Open User Type Modal - Show list and create form
        function openUserTypeModal() {
            openUsertypeListModal();
        }

        // Open Create User Modal
        function openCreateUserModal() {
            loadUserTypesForForm();
            openModal('createUserModal');
        }

        // Refresh data periodically
        setInterval(() => {
            loadActivities();
            loadDashboardStats();
        }, 60000); // Refresh every minute

        // Add remaining functions from original code that weren't redefined
        async function createMilestone() {
            const projectId =
                document.getElementById("milestoneProjectId").value;
            const name = document
                .getElementById("milestoneName")
                .value.trim();
            const description = document
                .getElementById("milestoneDescription")
                .value.trim();
            const dueDate =
                document.getElementById("milestoneDueDate").value;

            if (!name || !projectId) {
                showToast("Please fill in required fields", "error");
                return;
            }

            try {
                const response = await fetch("/api/employee/milestones", {
                    method: "POST",
                    headers: getHeaders(),
                    body: JSON.stringify({
                        title: name,
                        description: description,
                        project_id: parseInt(projectId),
                        due_date: dueDate || null,
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(
                        error.error || "Failed to create milestone",
                    );
                }

                showToast("Milestone created successfully!", "success");
                closeModal("createMilestoneModal");
                document.getElementById("createMilestoneForm").reset();
                if (currentProjectId) {
                    openProjectDetail(currentProjectId);
                }
            } catch (error) {
                showToast(error.message, "error");
            }
        }

        async function createTask() {
            const projectId =
                document.getElementById("taskProjectId").value;
            const milestoneId =
                document.getElementById("taskMilestone").value;
            const title = document.getElementById("taskTitle").value.trim();
            const description = document.getElementById("taskDescription").value.trim();
            const assigneeId =
                document.getElementById("taskAssignee").value;
            const priority = document.getElementById("taskPriority").value;
            const deadline = document.getElementById("taskDeadline").value;

            if (!title || !projectId) {
                showToast("Please fill in required fields", "error");
                return;
            }

            try {
                const response = await fetch("/api/employee/tasks", {
                    method: "POST",
                    headers: getHeaders(),
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        project_id: parseInt(projectId),
                        milestone_id: milestoneId
                            ? parseInt(milestoneId)
                            : null,
                        assigned_to_id: assigneeId
                            ? parseInt(assigneeId)
                            : null,
                        priority: priority,
                        deadline: deadline || null,
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || "Failed to create task");
                }

                showToast("Task created successfully!", "success");
                closeModal("createTaskModal");
                document.getElementById("createTaskForm").reset();
                await loadActiveTasks();
                await loadPendingTasks();
                await loadDashboardStats();
                if (currentProjectId) {
                    openProjectDetail(currentProjectId);
                }
            } catch (error) {
                showToast(error.message, "error");
            }
        }

        async function viewTaskHistory(taskId) {
            openModal("taskHistoryModal");
            const content = document.getElementById("taskHistoryContent");
            content.innerHTML =
                '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                const response = await fetch(
                    `/api/tasks/${taskId}/history`,
                    {
                        headers: getHeaders(),
                    },
                );

                if (!response.ok)
                    throw new Error("Failed to load task history");
                const data = await response.json();
                const history = data.history || [];
                const task = data.task || {};

                if (history.length === 0) {
                    content.innerHTML = `
                        <div class="mb-4">
                            <h4>${escapeHtml(task.title || "Task")}</h4>
                            <p class="text-muted">${escapeHtml(task.description || "No description")}</p>
                        </div>
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <h4>No History Available</h4>
                            <p>No activity has been recorded for this task yet.</p>
                        </div>
                    `;
                    return;
                }

                content.innerHTML = `
                    <div class="mb-4">
                        <h4>${escapeHtml(task.title || "Task")}</h4>
                        <p class="text-muted">${escapeHtml(task.description || "No description")}</p>
                        <div class="d-flex gap-3 mt-2">
                            <span class="status-badge ${(task.status || "pending").toLowerCase().replace(" ", "-")}">${task.status || "Pending"}</span>
                            <span class="text-muted"><i class="fas fa-user"></i> ${escapeHtml(task.assigned_to_name || "Unassigned")}</span>
                        </div>
                    </div>
                    <h5><i class="fas fa-history"></i> Activity Timeline</h5>
                    <div class="history-timeline">
                        ${history
                        .map((item) => {
                            const itemClass = getHistoryItemClass(
                                item.action_type || item.activity_type,
                            );
                            const time = item.created_at
                                ? new Date(item.created_at).toLocaleString()
                                : "";
                            return `
                                <div class="history-item ${itemClass}">
                                    <div class="content">
                                        <p><strong>${escapeHtml(item.username || "System")}</strong> ${escapeHtml(item.description || item.message)}</p>
                                        <div class="time">${time}</div>
                                    </div>
                                </div>
                            `;
                        })
                        .join("")}
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4>Error Loading History</h4>
                        <p>${escapeHtml(String(error))}</p>
                    </div>
                `;
            }
        }

        function getHistoryItemClass(type) {
            if (type && type.includes("created")) return "created";
            if (type && type.includes("assigned")) return "assigned";
            if (type && type.includes("progress")) return "progress";
            if (type && type.includes("completed")) return "completed";
            return "";
        }

        async function openProjectDetail(projectId) {
            currentProjectId = projectId;
            openModal("projectDetailModal");
            const content = document.getElementById("projectDetailContent");
            content.innerHTML =
                '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                // Load project details
                const projectResponse = await fetch(
                    `/api/admin/projects/${projectId}`,
                    {
                        headers: getHeaders(),
                    },
                );
                if (!projectResponse.ok)
                    throw new Error("Failed to load project");
                const project = await projectResponse.json();

                // Load milestones
                const milestonesResponse = await fetch(
                    `/api/projects/${projectId}/milestones`,
                    {
                        headers: getHeaders(),
                    },
                );
                let milestones = [];
                if (milestonesResponse.ok) {
                    milestones = await milestonesResponse.json();
                }

                // Load tasks
                const tasksResponse = await fetch(
                    `/api/projects/${projectId}/tasks`,
                    {
                        headers: getHeaders(),
                    },
                );
                let projectTasks = [];
                if (tasksResponse.ok) {
                    projectTasks = await tasksResponse.json();
                }

                document.getElementById("projectDetailTitle").textContent =
                    project.title || "Project Details";

                const progress = project.progress || 0;
                const progressClass =
                    progress < 33
                        ? "low"
                        : progress < 66
                            ? "medium"
                            : "high";

                content.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <p>${escapeHtml(project.description || "No description")}</p>
                            <div class="d-flex gap-3 flex-wrap">
                                <span><i class="fas fa-calendar"></i> Deadline: ${project.deadline ? new Date(project.deadline).toLocaleDateString() : "Not set"}</span>
                                <span><i class="fas fa-user"></i> Created by: ${escapeHtml(project.creator_name || "Unknown")}</span>
                                <span><i class="fas fa-clock"></i> Reporting: ${project.reporting_time || "09:00"}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="project-progress">
                                <div class="progress-header">
                                    <span class="progress-label">Overall Progress</span>
                                    <span class="progress-value">${progress}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill ${progressClass}" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h5><i class="fas fa-flag"></i> Milestones (${milestones.length})</h5>
                        ${milestones.length === 0
                        ? '<p class="text-muted">No milestones yet</p>'
                        : `
                            <div class="table-responsive">
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th>Milestone</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${milestones
                            .map(
                                (m) => `
                                            <tr>
                                                <td><strong>${escapeHtml(m.title)}</strong></td>
                                                <td>${m.due_date ? new Date(m.due_date).toLocaleDateString() : "Not set"}</td>
                                                <td><span class="status-badge ${(m.status || "pending").toLowerCase()}">${m.status || "Pending"}</span></td>
                                            </tr>
                                        `,
                            )
                            .join("")}
                                    </tbody>
                                </table>
                            </div>
                        `
                    }
                    </div>

                    <div>
                        <h5><i class="fas fa-tasks"></i> Tasks (${projectTasks.length})</h5>
                        ${projectTasks.length === 0
                        ? '<p class="text-muted">No tasks yet</p>'
                        : `
                            <div class="table-responsive">
                                <table class="task-table">
                                    <thead>
                                        <tr>
                                            <th>Task</th>
                                            <th>Assigned To</th>
                                            <th>Deadline</th>
                                            <th>Priority</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${projectTasks
                            .map(
                                (t) => `
                                            <tr>
                                                <td><strong>${escapeHtml(t.title)}</strong></td>
                                                <td>${escapeHtml(t.assigned_to_name || t.assigned_to || "Unassigned")}</td>
                                                <td>${t.deadline ? new Date(t.deadline).toLocaleDateString() : "Not set"}</td>
                                                <td><span class="status-badge priority-${(t.priority || "medium").toLowerCase()}">${t.priority || "Medium"}</span></td>
                                                <td><span class="status-badge ${(t.status || "pending").toLowerCase().replace(" ", "-")}">${t.status || "Pending"}</span></td>
                                            </tr>
                                        `,
                            )
                            .join("")}
                                    </tbody>
                                </table>
                            </div>
                        `
                    }
                    </div>
                `;

                // Update milestone select in task modal
                const milestoneSelect =
                    document.getElementById("taskMilestone");
                if (milestoneSelect) {
                    milestoneSelect.innerHTML =
                        '<option value="">Select Milestone (Optional)</option>';
                    milestones.forEach((m) => {
                        milestoneSelect.innerHTML += `<option value="${m.id}">${escapeHtml(m.title)}</option>`;
                    });
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4>Error Loading Project</h4>
                        <p>${escapeHtml(String(error))}</p>
                    </div>
                `;
            }
        }

        function openCreateMilestoneFromProject() {
            if (!currentProjectId) return;
            const project = projects.find((p) => p.id === currentProjectId);
            document.getElementById("milestoneProjectId").value =
                currentProjectId;
            document.getElementById("milestoneProjectName").value = project
                ? project.title
                : "Project " + currentProjectId;
            closeModal("projectDetailModal");
            openModal("createMilestoneModal");
        }

        function openCreateTaskFromProject() {
            if (!currentProjectId) return;
            const project = projects.find((p) => p.id === currentProjectId);
            document.getElementById("taskProjectId").value =
                currentProjectId;
            document.getElementById("taskProjectName").value = project
                ? project.title
                : "Project " + currentProjectId;
            closeModal("projectDetailModal");
            openModal("createTaskModal");
        }

        async function openHierarchyModal() {
            openModal("hierarchyModal");
            const content = document.getElementById("hierarchyContent");
            content.innerHTML =
                '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                const response = await fetch("/api/admin/user-hierarchy", {
                    headers: getHeaders(),
                });

                if (!response.ok)
                    throw new Error("Failed to load hierarchy");
                const hierarchy = await response.json();

                content.innerHTML = `
                    <div class="hierarchy-tree">
                        <div class="tree-item super-admin">
                            <span class="icon"><i class="fas fa-crown"></i></span>
                            <div>
                                <span class="name">Super Admin</span>
                                <span class="role">Full Access</span>
                            </div>
                        </div>
                        ${renderHierarchyTree(hierarchy)}
                    </div>
                `;
            } catch (error) {
                // Fallback to basic user list
                try {
                    const usersResponse = await fetch("/api/users", {
                        headers: getHeaders(),
                    });
                    if (!usersResponse.ok) throw error;
                    const usersList = await usersResponse.json();

                    const coordinators = usersList.filter(
                        (u) =>
                            u.user_role &&
                            u.user_role
                                .toLowerCase()
                                .includes("coordinator"),
                    );
                    const teamMembers = usersList.filter(
                        (u) =>
                            u.user_role &&
                            (u.user_role.toLowerCase().includes("member") ||
                                u.user_role
                                    .toLowerCase()
                                    .includes("employee")),
                    );

                    content.innerHTML = `
                        <div class="hierarchy-tree">
                            <div class="tree-item admin">
                                <span class="icon"><i class="fas fa-crown"></i></span>
                                <div>
                                    <span class="name"> Admin</span>
                                    <span class="role">Limited Access</span>
                                </div>
                            </div>
                            <div class="tree-node">
                                ${coordinators
                            .map(
                                (c) => `
                                    <div class="tree-item coordinator">
                                        <span class="icon"><i class="fas fa-user-tie"></i></span>
                                        <div>
                                            <span class="name">${escapeHtml(c.username)}</span>
                                            <span class="role">${escapeHtml(c.user_role || "Coordinator")}</span>
                                        </div>
                                    </div>
                                `,
                            )
                            .join("")}
                                <div class="tree-node">
                                    ${teamMembers
                            .map(
                                (m) => `
                                        <div class="tree-item team-member">
                                            <span class="icon"><i class="fas fa-user"></i></span>
                                            <div>
                                                <span class="name">${escapeHtml(m.username)}</span>
                                                <span class="role">${escapeHtml(m.user_role || "Team Member")}</span>
                                            </div>
                                        </div>
                                    `,
                            )
                            .join("")}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <h4>Error Loading Hierarchy</h4>
                            <p>${escapeHtml(String(error))}</p>
                        </div>
                    `;
                }
            }
        }

        function renderHierarchyTree(hierarchy) {
            if (!hierarchy || !Array.isArray(hierarchy) || hierarchy.length === 0) {
                return '<p class="text-muted ms-4">No users found</p>';
            }

            return `
        <div class="tree-node">
            ${hierarchy
                    .map((item) => {
                        // Determine icon class: allow full class (e.g. "fas fa-crown") or shorthand "crown"
                        let iconClass = 'fas fa-user';
                        if (item.icon) {
                            // If item.icon already contains a space (like "fas fa-crown") use it, else make fa-<icon>
                            iconClass = item.icon.includes(' ') ? item.icon : `fas fa-${item.icon}`;
                        }

                        // role_class fallback
                        const roleClass = item.role_class || (item.role ? item.role.toLowerCase().replace(/\s+/g, '-') : 'team-member');

                        return `
                        <div class="tree-item ${escapeHtml(roleClass)}">
                            <span class="icon"><i class="${escapeHtml(iconClass)}"></i></span>
                            <div>
                                <span class="name">${escapeHtml(item.name || item.username || '')}</span>
                                <span class="role">${escapeHtml(item.role || 'User')}</span>
                            </div>
                        </div>
                        ${item.children ? renderHierarchyTree(item.children) : ''}
                    `;
                    })
                    .join('')}
        </div>
    `;
        }



        // Load team member users
        async function loadTeamMemberUsers() {
            try {
                const response = await fetch("/api/users", {
                    headers: getHeaders(),
                });

                if (!response.ok) {
                    throw new Error("Failed to load users");
                }

                const allUsers = await response.json();
                const select = document.getElementById("teamMemberSelect");

                if (select) {
                    select.innerHTML = '<option value="">Select a team member</option>';
                    allUsers.forEach((user) => {
                        select.innerHTML += `<option value="${user.id}">${escapeHtml(user.username)}</option>`;
                    });
                }
            } catch (error) {
                console.error("Error loading team member users:", error);
                showToast("Error loading users", "error");
            }
        }

        // Load team member user types
        async function loadTeamMemberUserTypes() {
            try {
                const response = await fetch("/api/usertypes", {
                    headers: getHeaders(),
                });

                if (!response.ok) {
                    throw new Error("Failed to load user types");
                }

                const userTypesList = await response.json();
                const select = document.getElementById("teamMemberTypeSelect");

                if (select) {
                    select.innerHTML = '<option value="">Select user type</option>';
                    userTypesList.forEach((type) => {
                        select.innerHTML += `<option value="${type.id}">${escapeHtml(type.user_role)}</option>`;
                    });
                }
            } catch (error) {
                console.error("Error loading team member user types:", error);
                showToast("Error loading user types", "error");
            }
        }

        // Load existing project team members
        async function loadProjectTeamMembers(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}/team-members`, {
                    headers: getHeaders(),
                });

                let teamMembers = [];
                if (response.ok) {
                    teamMembers = await response.json();
                }

                const container = document.getElementById("existingTeamMembersContainer");
                if (!container) return;

                if (!teamMembers || teamMembers.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No team members assigned yet</p>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead style="background: var(--bg-secondary);">';
                html += '<tr>';
                html += '<th style="padding: 10px; text-align: left; font-weight: 600; font-size: 12px; border-bottom: 1px solid var(--border);">Name</th>';
                html += '<th style="padding: 10px; text-align: left; font-weight: 600; font-size: 12px; border-bottom: 1px solid var(--border);">User Type</th>';
                html += '<th style="padding: 10px; text-align: center; font-weight: 600; font-size: 12px; border-bottom: 1px solid var(--border);">Action</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                teamMembers.forEach((member) => {
                    html += '<tr style="border-bottom: 1px solid var(--border);">';
                    html += `<td style="padding: 10px;">${escapeHtml(member.username)}</td>`;
                    html += `<td style="padding: 10px;">${escapeHtml(member.user_role || "Employee")}</td>`;
                    html += `<td style="padding: 10px; text-align: center;"><button class="btn btn-sm btn-danger" onclick="removeTeamMember(${projectId}, ${member.user_id || member.id})"><i class="fas fa-trash"></i></button></td>`;
                    html += '</tr>';
                });

                html += '</tbody>';
                html += '</table>';

                container.innerHTML = html;
            } catch (error) {
                console.error("Error loading project team members:", error);
                const container = document.getElementById("existingTeamMembersContainer");
                if (container) {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 20px;">Unable to load team members</p>';
                }
            }
        }

        // Submit add team member form
        async function submitAddTeamMember() {
            const form = document.getElementById('addTeamMemberForm');
            const projectId = form.dataset.projectId;
            const userId = document.getElementById('teamMemberSelect').value;
            const errorDiv = document.getElementById('teamMemberError');

            if (!userId) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please select a team member';
                return;
            }

            // If this is being called from the create project form (no projectId)
            if (!projectId) {
                // Add to the project team container as a checkbox
                const container = document.getElementById('projectTeamContainer');
                const userSelect = document.getElementById('teamMemberSelect');
                const selectedOption = userSelect.options[userSelect.selectedIndex];
                const userName = selectedOption.text;

                // Check if already selected
                if (container.querySelector(`input[value="${userId}"]`)) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'This member is already selected';
                    return;
                }

                // Create checkbox element
                const teamMemberRow = document.createElement('div');
                teamMemberRow.className = 'team-member-row';
                teamMemberRow.style.display = 'flex';
                teamMemberRow.style.alignItems = 'center';
                teamMemberRow.style.padding = '10px';
                teamMemberRow.style.backgroundColor = 'var(--bg-secondary)';
                teamMemberRow.style.borderRadius = '4px';
                teamMemberRow.innerHTML = `
                    <input type="checkbox" value="${userId}" checked style="margin-right: 10px;">
                    <span>${escapeHtml(userName)}</span>
                    <button type="button" class="btn btn-sm btn-danger" style="margin-left: auto;" onclick="removeTeamMember(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                `;

                // Remove empty state message if it exists
                const emptyState = container.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                container.appendChild(teamMemberRow);
                updateTeamMemberCount();
                showToast(`${userName} added to team!`, 'success');
                form.reset();
                errorDiv.style.display = 'none';
                return;
            }

            // If projectId exists, use the API
            try {
                const response = await fetch(`/api/projects/${projectId}/add-team-member`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        user_id: parseInt(userId)
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Failed' }));
                    throw new Error(error.error || 'Failed to add team member');
                }

                showToast('Team member added successfully!', 'success');
                form.reset();
                errorDiv.style.display = 'none';
                await loadProjectTeamMembers(projectId);
            } catch (error) {
                console.error('Error adding team member:', error);
                errorDiv.style.display = 'block';
                errorDiv.textContent = error.message || 'Error adding team member';
            }
        }

        // Remove team member from project
        async function removeTeamMember(projectId, userId) {
            if (!confirm('Are you sure you want to remove this team member from the project?')) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}/remove-team-member`, {
                    method: 'DELETE',
                    headers: getHeaders(),
                    body: JSON.stringify({ user_id: userId })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Failed' }));
                    throw new Error(error.error || 'Failed to remove team member');
                }

                showToast('Team member removed successfully!', 'success');
                await loadProjectTeamMembers(projectId);
            } catch (error) {
                console.error('Error removing team member:', error);
                showToast(error.message || 'Error removing team member', 'error');
            }
        }

        async function openAddTeamMemberModal(projectId = null) {
            openModal('addTeamMemberModal');
            const form = document.getElementById('addTeamMemberForm');
            if (form) {
                form.reset();
                if (projectId) {
                    form.dataset.projectId = projectId;
                } else {
                    delete form.dataset.projectId;
                }
            }

            const errorDiv = document.getElementById('teamMemberError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.innerHTML = '';
            }

            // Load all available users for selection
            await loadTeamMemberUsers();

            // Load user types
            await loadTeamMemberUserTypes();

            // Load existing team members if project ID is provided
            if (projectId) {
                await loadProjectTeamMembers(projectId);
            } else {
                // For create project flow, show guidance
                const container = document.getElementById("existingTeamMembersContainer");
                if (container) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Project not yet created. Select members below to add after project creation.</p>';
                }
            }
        }

        function getUserTypeClass(userType) {

            if (!userType) return 'team-member';

            const t = String(userType).toLowerCase();
            if (t.includes('admin') || t.includes('super')) return 'super-admin';
            if (t.includes('coordinator') || t.includes('manager')) return 'coordinator';
            return 'team-member';
        }

    </script>
</body>

</html>